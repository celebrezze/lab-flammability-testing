---
title: "Thermocouple Temp. Data"
author: "Joe Celebrezze"
date: "2023-03-03"
output: html_document
---

Data cleaning prior to R: 
- Delete first rows of thermocoupler data

# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# packages
library(tidyverse)
library(here)
library(lubridate)
library(ggfortify)
library(hms)
library(caret) # for optimization routine

# defining functions
here = here::here

# reading in data
thermocoupler.files <- list.files(here('data', 'raw-data', 'thermocouplers'))
thermocoupler.df.list <- list()
for(i in 1:length(thermocoupler.files)){
  df <- read.csv(here('data', 'raw-data', 'thermocouplers', thermocoupler.files[[i]]))
  thermocoupler.df.list[[i]] <- df
}

flam.df <- read.csv(here('data', 'raw-data', 'flamm', 'burn_samples_flamm.csv'))
```

# Data Wrangling
## Datalogger Data
This includes data from the thermocouplers (CH1-6) as well as the heat flux sensors (CH7-8); the datalogger took data every 500 ms
```{r}
# Combining thermocoupler datasheets
thermocoupler.df <- do.call('rbind', thermocoupler.df.list)

# Getting temperature data in correct format
for(i in 4:11){
thermocoupler.df[,i] <- thermocoupler.df[,i] %>% 
  str_replace(pattern = '\\+ ', replacement = ' ') %>% 
  str_trim(side = c('left'))
thermocoupler.df[,i] <- as.numeric(thermocoupler.df[,i])
}
thermocoupler.df <- na.omit(thermocoupler.df)

# Splitting date and time into two columns
thermocoupler.df <- thermocoupler.df %>% 
  mutate(Date.Time = as.POSIXct(Date.Time) + 80) %>%  # Adjusting time so it matches time on clock
  mutate(date = as.Date(Date.Time)) %>% 
  mutate(time = format(as.POSIXct(Date.Time), format = "%H:%M:%S")) %>% 
  mutate(time = as_hms(time))

# For heat flux
heatflux.df <- thermocoupler.df %>% 
  select(date, time, ms, CH1, CH2, CH3, CH4, CH5, CH6, CH7, CH8)
heatflux.df.long <- heatflux.df %>% 
  select(date, time, ms, CH7, CH8) %>% 
  pivot_longer(cols = starts_with("CH"),
               names_to = 'sensor.id',
               values_to = 'heat.flux')

# Removing unncessary columns
thermocoupler.df <- thermocoupler.df %>% 
  select(date, time, ms, CH1, CH2, CH3, CH4, CH5, CH6)

# Lengthening dataframe
thermocoupler.df.long <- thermocoupler.df %>% 
  pivot_longer(cols = starts_with("CH"),
               names_to = 'thermo.id',
               values_to = 'temp')

# Combining dataframes
temp.heat.flux.df <- merge(thermocoupler.df.long, heatflux.df.long, by = c('date', 'time', 'ms'))
temp.heat.flux.df <- temp.heat.flux.df %>% 
  mutate(sensor.location = case_when(
    sensor.id == 'CH7' ~ 'Top',
    sensor.id == 'CH8' ~ 'Left Side'
  ))
```

## Flammability Data
### Clocktime, Date Wrangling
```{r}
flam.df <- flam.df %>% 
  mutate(start_time = start_time_clocktime) %>% 
  mutate(first_glow_time = glow_start_ct) %>% 
  mutate(primary_ignition = firstigstart_ct) %>% 
  mutate(primary_time_of_flame_end = firstigend_ct) %>% 
  mutate(secondary_ignition = secondigstart_ct) %>% 
  mutate(secondary_time_of_flame_end = secondigend_ct) %>% 
  mutate(time_fh = maxflameht_ct) %>% 
  mutate(time_of_glow_end = glow_end_ct) %>% 
  mutate(end_time = end_ct) %>% 
  select(-c(start_time_clocktime, glow_start_ct, firstigstart_ct, firstigend_ct, secondigstart_ct, secondigend_ct, maxflameht_ct, glow_end_ct, end_ct))

flam.df <- replace(flam.df, flam.df=='', NA)

flam.df <- flam.df %>% 
  mutate(start_time = as_hms(format(as.POSIXct(start_time), format = "%H:%M:%S"))) %>% 
  mutate(first_glow_time = as_hms(format(as.POSIXct(first_glow_time), format = "%H:%M:%S"))) %>% 
  mutate(primary_ignition = as_hms(format(as.POSIXct(primary_ignition), format = "%H:%M:%S"))) %>% 
  mutate(primary_time_of_flame_end = as_hms(format(as.POSIXct(primary_time_of_flame_end), format = "%H:%M:%S"))) %>% 
  mutate(secondary_ignition = as_hms(format(as.POSIXct(secondary_ignition), format = "%H:%M:%S"))) %>% 
  mutate(secondary_time_of_flame_end = as_hms(format(as.POSIXct(secondary_time_of_flame_end), format = "%H:%M:%S"))) %>% 
  mutate(time_of_glow_end = as_hms(format(as.POSIXct(time_of_glow_end), format = "%H:%M:%S"))) %>% 
  mutate(time_fh = as_hms(format(as.POSIXct(time_fh), format = "%H:%M:%S"))) %>% 
  mutate(end_time = as_hms(format(as.POSIXct(end_time), format = "%H:%M:%S"))) %>% 
  mutate(date = as.Date(date))
```

### Calculating Flam. Metrics (1)
Flame duration, time to ignition, post-flame glow
```{r}
flam.df <- flam.df %>% 
  mutate(pre_ignition_glow = as.numeric(pre_ignition_glow)) %>% 
  mutate(fh = as.numeric(fh)) %>% 
  # FLAME DURATION
  mutate(fd = primary_time_of_flame_end - primary_ignition) %>% 
  mutate(fd = as.numeric(fd)) %>% 
  # TIME TO IGNITION
  mutate(tti = primary_ignition - start_time) %>% 
  mutate(tti = as.numeric(tti)) %>% 
  # POST FLAME GLOW
  mutate(pfg = time_of_glow_end - primary_time_of_flame_end) %>% 
  mutate(pfg = as.numeric(pfg))
```

### Calculating Temp. Metrics
Maximum Temperature
```{r, warning = F}
flam.df <- flam.df %>% 
  mutate(max_temp = NA) %>% 
  mutate(time_at_max_temp = NA) %>% 
  mutate(max_temp_sensor = NA)
thermocoupler.df.long <- thermocoupler.df.long %>% 
  mutate(max_temp = NA) 
for(i in 1:nrow(flam.df)){
  df <- thermocoupler.df.long %>% 
    filter(thermo.id %in% c('CH1', 'CH2', 'CH5', 'CH6')) %>% # if we want to exclude vent thermocoupler, top glass thermocoupler
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$primary_ignition[i] & time <= flam.df$primary_time_of_flame_end[i]) #again, index row, select columns
  flam.df$max_temp[i] <- max(df$temp)
  df$max_temp <- case_when(df$temp == flam.df$max_temp[i] ~ 'yes')
  df.mt <- df %>% 
    filter(max_temp == 'yes')
  flam.df$time_at_max_temp[i] <- df.mt$time[1]
  flam.df$max_temp_sensor[i] <- df.mt$thermo.id[1]
}
flam.df <- flam.df %>% 
  mutate(time_at_max_temp = as_hms(time_at_max_temp))

#rm(df, df.mt) # Decluttering environment by removing temporary dataframes from above for loop
```

Starting Temp. and Temp. Change
```{r, warning = F}
flam.df <- flam.df %>% 
  mutate(start_temp = NA) %>% 
  mutate(start_temp_sensor = NA)
thermocoupler.df.long <- thermocoupler.df.long %>% 
  mutate(start_temp = 'yes')
for(i in 1:nrow(flam.df)){
  df <- thermocoupler.df.long %>% 
    filter(thermo.id %in% c('CH1', 'CH2', 'CH5', 'CH6')) %>% # if we want to exclude vent thermocoupler, top glass thermocoupler
    filter(date == flam.df$date[i]) %>% 
    filter(time == flam.df$start_time[i]) %>% 
    filter(ms == 0)
  flam.df$start_temp[i] <- max(df$temp)
  df$start_temp <- case_when(df$temp == flam.df$start_temp[i] ~ 'yes')
  df.st <- df %>% 
    filter(start_temp == 'yes')
  flam.df$start_temp_sensor[i] <- df.st$thermo.id[1]
}
flam.df <- flam.df %>% 
  mutate(temp_change = max_temp - start_temp)

rm(df) # Decluttering environment by removing temporary dataframe from above for loop
```

Average Temp
```{r}
flamm.df <- flamm.df %>% 
  mutate(start_time = as_hms(start_time),
           end_time = as_hms(end_time)) %>% 
  mutate(avg_temp_ch2 = NA) %>% 
  mutate(avg_temp_ch6 = NA)
for(i in 1:nrow(flamm.df)){
  df <- thermocoupler.df.long %>% 
    filter(thermo.id %in% c('CH2', 'CH6')) %>% # if we want to exclude vent thermocoupler, top glass thermocoupler
    pivot_wider(names_from = 'thermo.id', values_from = 'temp') %>% 
    filter(date == flamm.df$date[i]) %>% 
    filter(time > flamm.df$start_time[i] & time < flamm.df$end_time[i]) %>% 
    filter(ms == 0)
  flamm.df$avg_temp_ch2[i] <- mean(df$CH2)
  flamm.df$avg_temp_ch6[i] <- mean(df$CH6)
}

flamm.df %>% 
  ggplot(aes(x = date, y = avg_temp_ch6)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = 0.1, height = 0.01, alpha = 0.4, aes(color = species)) +
    labs(x = "Date", y = "Avg Temp. (CH6)", color = 'Species') +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12, angle = 20))

flamm.df %>% 
  ggplot(aes(x = avg_temp_ch6, y = fh)) +
    geom_point() +
    geom_smooth() +
    labs(x = "Avg Temp. (CH6)", y = "Flame Height") +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12, angle = 20))

# Proportion Ignited (per day)
flam.df.prop.ig1 <- flam.df %>% 
  group_by(date) %>%
  dplyr::summarise(n = n()) %>% 
  ungroup() 
  
flam.df.prop.ig2 <- flam.df %>% 
  filter(ignition %in% c('M', '0')) %>% 
  group_by(date) %>% 
  dplyr::summarise(manual_or_nonignitions = n()) %>% 
  select(manual_or_nonignitions)

flam.df.prop.ig <- cbind(flam.df.prop.ig1, flam.df.prop.ig2) %>% 
  mutate(prop_ig_date = (n-manual_or_nonignitions)/n)

rm(flam.df.prop.ig1, flam.df.prop.ig2) # Decluttering environment by removing temporary dataframes

flam.df.prop.ig <- flam.df.prop.ig %>% 
  select(date, prop_ig_date)
flamm.df.prop.ig <- merge(flamm.df, flam.df.prop.ig, by = 'date')

flamm.df.prop.ig %>% 
  group_by(date) %>% 
  dplyr::summarise(prop_ig_date = prop_ig_date, avg_temp_ch2 = mean(avg_temp_ch2), avg_temp_ch6 = mean(avg_temp_ch6)) %>% 
  ggplot(aes(x = avg_temp_ch2, y = prop_ig_date)) +
    geom_point() +
    labs(x = "Avg Temp. (CH2)", y = "Proportion Ignited (per day)") +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12, angle = 20))
```


### Calculating Heat Flux
#### Max. Heat Flux
Still deciding on what to use here... top sensor, side sensor, avg of both?

Raw data
```{r, warning = F}
flam.df <- flam.df %>% 
  mutate(max_heat_flux = NA) %>% 
  mutate(time_at_max_heat_flux = NA)
temp.heat.flux.df <- temp.heat.flux.df %>% 
  mutate(max_heat_flux = NA) 
for(i in 1:nrow(flam.df)){
  df <- temp.heat.flux.df %>% 
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$start_time[i] & time <= flam.df$time_of_glow_end[i]) #again, index row, select columns
  flam.df$max_heat_flux[i] <- max(df$heat.flux)
  df$max_heat_flux <- case_when(df$heat.flux == flam.df$max_heat_flux[i] ~ 'yes')
  df.mhf <- df %>% 
    filter(max_heat_flux == 'yes')
  flam.df$time_at_max_heat_flux[i] <- df.mhf$time[1]
}
flam.df <- flam.df %>% 
  mutate(time_at_max_heat_flux = as_hms(time_at_max_heat_flux))

rm(df, df.mhf) # Decluttering environment by removing temporary dataframes from above for loop
```

Loess regressions
```{r}
flam.df <- flam.df %>% 
  mutate(max_heat_flux_loessCH7 = NA) %>% 
  mutate(time_at_max_heat_flux_loessCH7 = NA) %>% 
  mutate(max_heat_flux_loessCH8 = NA) %>% 
  mutate(time_at_max_heat_flux_loessCH8 = NA)
heatflux.df <- heatflux.df %>% 
  mutate(max_heat_flux_loessCH7 = NA)  %>% 
  mutate(max_heat_flux_loessCH8 = NA)
# NOTE: THIS PART WILL NOT BE NECESSARY WHEN ALL DATALOGGER DATA IS INPUTTED
flam.df.no.Inf <- flam.df %>% 
  filter(max_heat_flux > 0)
flam.df.Inf <- flam.df %>% 
  filter(max_heat_flux < 0) 

for(i in 1:nrow(flam.df.no.Inf)){
  df <- heatflux.df %>% 
    filter(date == flam.df.no.Inf$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df.no.Inf$start_time[i] & time <= flam.df.no.Inf$time_of_glow_end[i]) %>% #again, index row, select columns
    mutate(time = as.numeric(time))
  
# Loess regressions
  loess.mod.CH7 <- loess(CH7 ~ time, data = df, span = 0.09826087)
  df$loess.CH7 <- predict(loess.mod.CH7)
  loess.mod.CH8 <- loess(CH8 ~ time, data = df, span = 0.02608696)
  df$loess.CH8 <- predict(loess.mod.CH8)

  flam.df.no.Inf$max_heat_flux_loessCH7[i] <- max(df$loess.CH7)
  flam.df.no.Inf$max_heat_flux_loessCH8[i] <- max(df$loess.CH8)
  
  df$max_heat_flux_loessCH7 <- case_when(df$loess.CH7 == flam.df.no.Inf$max_heat_flux_loessCH7[i] ~ 'yes')
  df$max_heat_flux_loessCH8 <- case_when(df$loess.CH8 == flam.df.no.Inf$max_heat_flux_loessCH8[i] ~ 'yes')
  
  df.mhf_CH7 <- df %>% 
    filter(max_heat_flux_loessCH7 == 'yes')
  flam.df.no.Inf$time_at_max_heat_flux_loessCH7[i] <- df.mhf_CH7$time[1]
  df.mhf_CH8 <- df %>% 
    filter(max_heat_flux_loessCH8 == 'yes')
  flam.df.no.Inf$time_at_max_heat_flux_loessCH8[i] <- df.mhf_CH8$time[1]
}
flam.df.no.Inf <- flam.df.no.Inf %>% 
  mutate(time_at_max_heat_flux_loessCH7 = as_hms(time_at_max_heat_flux_loessCH7)) %>% 
  mutate(time_at_max_heat_flux_loessCH8 = as_hms(time_at_max_heat_flux_loessCH8))

flam.df <- rbind(flam.df.no.Inf, flam.df.Inf)

rm(df, df.mhf_CH7, df.mhf_CH8) # Decluttering environment by removing temporary dataframes from above for loop
```

#### Avg. Heat Flux (flame duration)
```{r}
flam.df <- flam.df %>% 
  mutate(avg_fd_heat_flux = NA)

for(i in 1:nrow(flam.df)){
  df <- temp.heat.flux.df %>% 
    filter(sensor.id == 'CH8') %>% # looking at side sensor only (less noise)
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$primary_ignition[i] & time <= flam.df$primary_time_of_flame_end[i]) %>% 
    summarise(avg_fd_heat_flux = mean(heat.flux))
  flam.df$avg_fd_heat_flux[i] <- df$avg_fd_heat_flux
}
rm(df) # Decluttering environment by removing temporary dataframe from above for loop
```

# Calculating Average Temp. Pre-ignition
```{r}
flam.df <- flam.df %>% 
  mutate(avg_temp_flamehtCH1 = NA) %>% 
  mutate(time_at_max_temp_flamehtCH1 = NA)
thermocoupler.df.long <- thermocoupler.df.long %>% 
  mutate(max_temp = NA) 
for(i in 1:nrow(flam.df)){
  df <- thermocoupler.df.long %>%
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$time_fh[i]-2 & time <= flam.df$time_fh[i] + 2) %>% 
    filter(thermo.id == 'CH1')
  flam.df$max_temp_flamehtCH1[i] <- max(df$temp)
  df$max_temp <- case_when(df$temp == flam.df$max_temp_flamehtCH1[i] ~ 'yes')
  df.mt <- df %>% 
    filter(max_temp == 'yes')
  flam.df$time_at_max_temp_flamehtCH1[i] <- df.mt$time[1]
}
flam.df <- flam.df %>% 
  mutate(time_at_max_temp_flamehtCH1 = as_hms(time_at_max_temp_flamehtCH1))
```

```{r}
heatflux.vis <- function(index){
heatflux.df.woop <- heatflux.df %>% 
  filter(date == flam.df.no.Inf$date[index]) %>%  #index row, select column for date
  filter(time >= flam.df.no.Inf$start_time[index] & time <= flam.df.no.Inf$time_of_glow_end[index]) %>% 
  mutate(time = as.numeric(time))

loess.mod.CH7 <- loess(CH7 ~ as.numeric(time), data = heatflux.df.woop, span = 0.0983)
heatflux.df.woop$loess.CH7 <- predict(loess.mod.CH7)

ch7.title <- paste('Top Sensor (span = 0.0983)', flam.df.no.Inf$species[index], flam.df.no.Inf$plant[index], flam.df.no.Inf$rep[index], 'ignition =', flam.df.no.Inf$ignition[index])

plot.top <- ggplot(heatflux.df.woop, aes(x = time)) +
  geom_point(aes(y = loess.CH7), color = 'black') +
  geom_point(aes(y = CH7), color = 'blue', alpha = 0.2) +
  geom_vline(xintercept = flam.df.no.Inf$primary_ignition[index], linetype = 4) +
  annotate('text', label = 'Primary Ignition', x = flam.df.no.Inf$primary_ignition[index], y = 0.95, fontface = 'bold') +
  geom_vline(xintercept = flam.df.no.Inf$time_at_max_heat_flux_loessCH7[index], linetype = 5) +
  annotate('text', label = 'Max Heat Flux', x = flam.df.no.Inf$time_at_max_heat_flux_loessCH7[index], y = 1, fontface = 'bold') +
  labs(x = 'Time', y = 'Heat Flux (Top Sensor)', title = ch7.title) +
  theme_bw() + 
  theme(axis.title = element_text(face = 'bold', size = 14),
        axis.text = element_text(size = 12))

loess.mod.CH8 <- loess(CH8 ~ as.numeric(time), data = heatflux.df.woop, span = 0.0261)
heatflux.df.woop$loess.CH8 <- predict(loess.mod.CH8)

ch8.title <- paste('Side Sensor (span = 0.0261)', flam.df.no.Inf$species[index], flam.df.no.Inf$plant[index], flam.df.no.Inf$rep[index], 'ignition =', flam.df.no.Inf$ignition[index])

plot.side <- ggplot(heatflux.df.woop, aes(x = time)) +
  geom_point(aes(y = loess.CH8), color = 'black') +
  geom_point(aes(y = CH8), color = 'blue', alpha = 0.2) +
  geom_vline(xintercept = flam.df.no.Inf$primary_ignition[index], linetype = 4) +
  annotate('text', label = 'Primary Ignition', x = flam.df.no.Inf$primary_ignition[index], y = 0.5, fontface = 'bold') +
  geom_vline(xintercept = flam.df.no.Inf$time_at_max_heat_flux_loessCH8[index], linetype = 5) +
  annotate('text', label = 'Max Heat Flux', x = flam.df.no.Inf$time_at_max_heat_flux_loessCH8[index], y = 0.55, fontface = 'bold') +
  labs(x = 'Time', y = 'Heat Flux (Side Sensor)', title = ch8.title) +
  theme_bw() +  
  theme(axis.title = element_text(face = 'bold', size = 14),
        axis.text = element_text(size = 12))
print(plot.side)
print(plot.top)
}
```

```{r}
heatflux.vis(2)
```

# Average Heat Flux of Flame Duration
```{r}
flam.df <- flam.df %>% 
  mutate(avg_fd_heat_flux = NA)

for(i in 1:nrow(flam.df)){
  df <- temp.heat.flux.df %>% 
    filter(sensor.id == 'CH7') %>% 
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$primary_ignition[i] & time <= flam.df$primary_time_of_flame_end[i]) %>% 
    summarise(avg_fd_heat_flux = mean(heat.flux))
  flam.df$avg_fd_heat_flux[i] <- df$avg_fd_heat_flux
}
```

# Visualization
```{r}
plot.list <- list()
for(i in 1:nrow(flam.df)){
  plot.id <- paste0('thermocoupler_vis_', flam.df$species[i], '_', flam.df$plant[i], '_', flam.df$rep[i])
  title.id <- paste0(flam.df$species[i], '_', flam.df$plant[i], '_', flam.df$rep[i],  '_ignition=', flam.df$ignition[i])
  df <- thermocoupler.df.long %>% 
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$start_time[i] & time <= flam.df$time_of_glow_end[i]) #again, index row, select columns for start time and end time
  plot <- ggplot(data = df, aes(x = time, y = temp, color = thermo.id)) +
    geom_point(size = 1) +
    # max flame height
    geom_vline(xintercept = flam.df$time_fh[i], linewidth = 1, alpha = 0.4) + #index row, select column for time for max flame height
    annotate('text', label = 'Max. Flame Height', x = flam.df$time_fh[i], y = 255, fontface = 'bold') +
    # max temp
    geom_vline(xintercept = flam.df$time_at_max_temp[i], linewidth = 1, alpha = 0.4) + #index row, select column for time for max temp
    annotate('text', label = 'Max. Temp.', x = flam.df$time_at_max_temp[i], y = 245, fontface = 'bold') +
    theme_bw() +
    labs(x = "Time", y = "Temperature (C)", color = "Thermocoupler ID", title = title.id) +
    theme(axis.title = element_text(face = 'bold', size = 14),
          axis.text.y = element_text(size = 12),
          axis.text.x = element_blank(),
          legend.title = element_text(face = 'bold', size = 14),
          legend.text = element_text(size = 12))
  #assign(x = plot.id, value = plot)
  plot.list[[i]] <- plot
}
```

## Plots
```{r}
plot.list[[7]]
plot.list[[17]]
plot.list[[19]]
plot.list[[23]]
plot.list[[28]]
plot.list[[31]]
plot.list[[51]]
plot.list[[54]]
plot.list[[65]]
plot.list[[78]]
plot.list[[80]]
plot.list[[82]]
plot.list[[88]]
plot.list[[90]]
plot.list[[149]]
plot.list[[237]]
plot.list[[227]]
plot.list[[231]]
plot.list[[267]]
plot.list[[273]]
plot.list[[274]]
plot.list[[276]]
plot.list[[277]]
plot.list[[279]]
plot.list[[283]]
plot.list[[288]]
plot.list[[295]]
plot.list[[297]]
plot.list[[301]]
plot.list[[302]]
plot.list[[307]]
plot.list[[314]]
plot.list[[321]]
plot.list[[322]]
plot.list[[325]]
plot.list[[348]]
```

HETARB shows very low temperatures for 4/6 thermocouples. What is going on?
```{r}
thermocoupler.df.long %>% 
    ggplot(aes(x = time, y = temp, color = thermo.id)) +
      geom_point(size = 0.4) +
      theme_bw() +
      labs(x = "Time", y = "Temperature (C)", color = "Thermocoupler ID",
           title = "Differences Between Dates") +
      facet_wrap(~date, ncol = 1) +
      theme(axis.title = element_text(face = 'bold', size = 14),
          axis.text.y = element_text(size = 12),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          legend.title = element_text(face = 'bold', size = 14),
          legend.text = element_text(size = 12))
```

# Heat Flux
```{r}
plot.list <- list()
for(i in 1:nrow(flam.df)){
  plot.id <- paste0('heatflux_vis_', flam.df$species[i], '_', flam.df$plant[i], '_', flam.df$rep[i])
  title.id <- paste0(flam.df$species[i], '_', flam.df$plant[i], '_', flam.df$rep[i], '_ignition.type:', flam.df$ignition[i])
  
  df <- temp.heat.flux.df %>% 
    filter(date == flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= flam.df$start_time[i] & time <= flam.df$time_of_glow_end[i]) #again, index row, select columns for start time and end time
  plot <- ggplot(data = df, aes(x = time, y = heat.flux, color = sensor.location)) +
    geom_point(size = 1) +
    # max flame height
    geom_vline(xintercept = flam.df$time_fh[i], linewidth = 1, alpha = 0.4) + #index row, select column for time for max flame height
    annotate('text', label = 'Max. Flame Height', x = flam.df$time_fh[i], y = 1.4, fontface = 'bold') +
    # max temp
    geom_vline(xintercept = flam.df$time_at_max_temp[i], linewidth = 1, alpha = 0.4) + #index row, select column for time for max temp
    annotate('text', label = 'Max. Temp.', x = flam.df$time_at_max_temp[i], y = 1.3, fontface = 'bold') +
    geom_vline(xintercept = flam.df$time_at_max_heat_flux[i], linewidth = 1, alpha = 0.4) +    
    annotate('text', label = 'Max. Heat Flux', x = flam.df$time_at_max_heat_flux[i], y = 1.5, fontface = 'bold') +
    theme_bw() +
    labs(x = "Time", y = "Heat Flux", color = "Sensor Location", title = title.id) +
    theme(axis.title = element_text(face = 'bold', size = 14),
          axis.text.y = element_text(size = 12),
          axis.text.x = element_blank(),
          legend.title = element_text(face = 'bold', size = 14),
          legend.text = element_text(size = 12))
  #assign(x = plot.id, value = plot)
  plot.list[[i]] <- plot
}
```

Plots
```{r}
plot.list[[1]]
plot.list[[4]]
plot.list[[7]]
plot.list[[16]]
plot.list[[20]]
plot.list[[47]]
plot.list[[69]]
plot.list[[71]]
plot.list[[73]]
plot.list[[99]]
```

# Temp and Heat Flux
Investigating differences between manual ignitions and natural ignitions
```{r}
plot.list <- list()
sample.subset <- c(4, 5, 11, 32, 59, 1, 8, 16, 7, 24)
sample.subset.ig <- c(rep(1, 5), rep('M', 5))
for(i in sample.subset){
df <- temp.heat.flux.df %>% 
  filter(date == flam.df$date[i]) %>%  #index row, select column for date
  filter(time >= flam.df$start_time[i] & time <= flam.df$time_of_glow_end[i])

title.id <- paste0(flam.df$species[i], '_', flam.df$plant[i], '_', flam.df$rep[i], '_ignition.type:', flam.df$ignition[i])

plot <- ggplot(data = df, aes(x = time, y = temp)) +    
    geom_point(size = 0.6, aes(y = temp, color = thermo.id)) +
    geom_point(size = 1, alpha = 0.3, aes(y = heat.flux*100, color = sensor.id)) +
    scale_y_continuous(sec.axis = sec_axis(~.*.01, name="Heat Flux")) +
    # max flame height
    scale_color_manual(values = c('#02C3BD', '#00B9AE', '#009F93', '#037171',  '#03312E', 'black', '#D6A184', '#A63D40')) +
    geom_vline(xintercept = flam.df$time_fh[i], linewidth = 1, alpha = 0.4) + 
    annotate('text', label = 'M.FH', x = flam.df$time_fh[i], y = 255, fontface = 'bold') +
    # max temp
    geom_vline(xintercept = flam.df$time_at_max_temp[i], linewidth = 1, alpha = 0.4) +
    annotate('text', label = 'M.Temp.', x = flam.df$time_at_max_temp[i], y = 245, fontface = 'bold') +
    geom_vline(xintercept = flam.df$time_at_max_heat_flux[i], linewidth = 1, alpha = 0.4) +    
    annotate('text', label = 'M. Heat Flux', x = flam.df$time_at_max_heat_flux[i], y = 237, fontface = 'bold') +
    theme_bw() +
    labs(x = "Time", y = "Temperature", color = " ", title = title.id) +
    theme(axis.title = element_text(face = 'bold', size = 14),
          axis.text.y = element_text(size = 12),
          axis.text.x = element_blank(),
          legend.title = element_text(face = 'bold', size = 14),
          legend.text = element_text(size = 12))
  plot.list[[i]] <- plot
}
```

```{r}
# Natural ignitions (ignition = 1)
plot.list[[4]]
plot.list[[5]]
plot.list[[11]]
plot.list[[32]]
plot.list[[59]]

# Manual ignitions (ignition = M)
plot.list[[1]]
plot.list[[7]]
plot.list[[8]]
plot.list[[16]]
plot.list[[24]]
```

# August 24 Heat Flux, Temp. Time Series
```{r}
aug24.flam.df <- flam.df %>% 
  filter(date == '2022-08-24')
```

```{r}
plot.list <- list()
for(i in 1:nrow(aug24.flam.df)){
  plot.id <- paste0('thermocoupler_vis_', aug24.flam.df$species[i], '_', aug24.flam.df$plant[i], '_', aug24.flam.df$rep[i])
  title.id <- paste0(aug24.flam.df$species[i], '_', aug24.flam.df$plant[i], '_', aug24.flam.df$rep[i],  '_ignition=', aug24.flam.df$ignition[i])
  df <- thermocoupler.df.long %>% 
    filter(date == aug24.flam.df$date[i]) %>%  #index row, select column for date
    filter(time >= aug24.flam.df$start_time[i] & time <= aug24.flam.df$time_of_glow_end[i]) #again, index row, select columns for start time and end time
  plot <- ggplot(data = df, aes(x = time, y = temp, color = thermo.id)) +
    geom_point(size = 1) +
    # max flame height
    geom_vline(xintercept = aug24.flam.df$time_fh[i], linewidth = 1, alpha = 0.4) + #index row, select column for time for max flame height
    annotate('text', label = 'Max. Flame Height', x = aug24.flam.df$time_fh[i], y = 255, fontface = 'bold') +
    # max temp
    geom_vline(xintercept = aug24.flam.df$time_at_max_temp[i], linewidth = 1, alpha = 0.4) + #index row, select column for time for max temp
    annotate('text', label = 'Max. Temp.', x = aug24.flam.df$time_at_max_temp[i], y = 245, fontface = 'bold') +
    theme_bw() +
    labs(x = "Time", y = "Temperature (C)", color = "Thermocoupler ID", title = title.id) +
    theme(axis.title = element_text(face = 'bold', size = 14),
          axis.text.y = element_text(size = 12),
          axis.text.x = element_blank(),
          legend.title = element_text(face = 'bold', size = 14),
          legend.text = element_text(size = 12))
  #assign(x = plot.id, value = plot)
  plot.list[[i]] <- plot
}
```

## Plots
```{r}
plot.list[[1]]
plot.list[[2]]
plot.list[[3]]
plot.list[[4]]
plot.list[[5]]
plot.list[[6]]
plot.list[[7]]
plot.list[[8]]
plot.list[[9]]
plot.list[[10]]
plot.list[[11]]
plot.list[[12]]
plot.list[[13]]
plot.list[[14]]
plot.list[[15]]
plot.list[[16]]
plot.list[[17]]
plot.list[[18]]
```

```{r}
df <- thermocoupler.df.long %>% 
    filter(date == aug24.flam.df$date[1]) %>%  #index row, select column for date
    filter(time >= aug24.flam.df$start_time[2] & time <= aug24.flam.df$time_of_glow_end[18])

plot <- ggplot(data = df, aes(x = time, y = temp, color = thermo.id)) +
    geom_point(size = 1) +
    theme_bw() +
    labs(x = "Time", y = "Temperature (C)", color = "Thermocoupler ID") +
    theme(axis.title = element_text(face = 'bold', size = 14),
          axis.text.y = element_text(size = 12),
          axis.text.x = element_blank(),
          legend.title = element_text(face = 'bold', size = 14),
          legend.text = element_text(size = 12))
plot
```

early queagr ignitions
```{r}
queagr.flam.df <- flam.df %>% 
  filter(species == 'QUEAGR')
```

# Summaries
## Temperature
Here are the various ways we've quantified temperature above:
- 